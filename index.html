<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controls Team Scheduler v6.0</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";
        window.Octokit = Octokit;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        body { background-color: #0e1117; color: white; padding-bottom: 80px; overflow: hidden; }
        
        /* --- CALENDAR POLISH --- */
        .fc { height: 85vh; margin: 20px; }
        .fc-toolbar-title { font-size: 1.5rem !important; }
        .fc a { text-decoration: none !important; color: inherit !important; }
        
        /* Month View Tweaks */
        .fc-col-header-cell-cushion { color: white !important; } 
        .fc-daygrid-day-number { color: rgba(255, 255, 255, 0.75) !important; padding: 4px 8px !important; }
        
        /* --- LIST VIEW OVERHAUL (Agenda Cards) --- */
        .fc-list { border: none !important; }
        .fc-list-day-cushion { background-color: #1a1b21 !important; border-bottom: 1px solid #333; padding: 12px 15px !important; }
        .fc-list-day-text { font-size: 1.1em; font-weight: bold; color: #0d6efd !important; text-transform: uppercase; letter-spacing: 1px; }
        .fc-list-day-side-text { color: #888 !important; font-weight: normal; }
        
        /* Transform Table Rows into Cards */
        .fc-list-table { border-spacing: 0 8px !important; border-collapse: separate !important; }
        .fc-list-event {
            background-color: #212529 !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border-radius: 8px;
            transition: transform 0.1s, background-color 0.1s;
        }
        .fc-list-event:hover { transform: scale(1.01); background-color: #2c3036 !important; }
        .fc-list-event td { border: none !important; padding: 15px !important; }
        
        /* Time Column Styling */
        .fc-list-event-time { white-space: nowrap; width: 120px; font-weight: bold; color: #bbb; }
        
        /* Event Dot */
        .fc-list-event-graphic { display: none; } /* Hide default dot */
        .fc-list-event-title { border-left: 4px solid; padding-left: 15px !important; } /* Use left border as color indicator */

        /* --- MODALS --- */
        .modal-dialog { max-width: 900px !important; }
        .modal-sm { max-width: 400px !important; }
        
        /* --- GRID LIST SYSTEM --- */
        .grid-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 10px;
            padding: 5px;
            max-height: 500px; 
            overflow-y: auto;
        }
        
        .grid-item {
            background-color: #212529;
            border: 1px solid #495057;
            border-radius: 6px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }
        .grid-item:hover { background-color: #2c3036; }

        .name-truncate {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px; font-size: 1.1em; flex-grow: 1;
        }

        .filter-label { cursor: pointer; display: flex; align-items: center; width: 100%; margin: 0; }

        /* --- DROPDOWN GRID FIX --- */
        .dropdown-menu.grid-list { display: none; }
        .dropdown-menu.grid-list.show { display: grid; }
        
        .dropdown-item-checkbox { 
            padding: 0; cursor: pointer; display: flex; align-items: center; font-size: 1.1em; margin: 0; width: 100%;
        }

        /* --- TIME PICKER WALL --- */
        .time-picker-dropdown {
            position: absolute; width: 100%; background: #212529; border: 1px solid #495057; border-radius: 0.375rem; z-index: 1055; box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            display: none; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 5px; padding: 10px; max-height: 300px; overflow-y: auto;
        }
        .time-option {
            padding: 8px 4px; text-align: center; cursor: pointer; border: 1px solid #343a40; border-radius: 4px; font-size: 0.9em; background-color: #2b3035; transition: all 0.1s;
        }
        .time-option:hover { background-color: #495057; border-color: #6c757d; }
        .time-option.selected { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .time-option.in-range { background-color: rgba(13, 110, 253, 0.3); border-color: rgba(13, 110, 253, 0.5); }

        .grid-list::-webkit-scrollbar, .time-picker-dropdown::-webkit-scrollbar { width: 8px; }
        .grid-list::-webkit-scrollbar-thumb, .time-picker-dropdown::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        
        .color-swatch { display: inline-block; width: 20px; height: 20px; border-radius: 4px; margin-right: 12px; }
        .btn-icon { padding: 4px 8px; margin-left: 5px; }
        #loading-spinner { display: none; margin-left: 10px; }
        
        .bottom-dock {
            position: fixed; bottom: 0; left: 0; width: 100%; background-color: #1a1b21; border-top: 1px solid #333; padding: 15px; display: flex; gap: 10px; justify-content: center; z-index: 1000;
        }
        .dock-btn {
            background-color: #262730; border: 1px solid #444; color: white; font-weight: 600; padding: 10px 15px; border-radius: 8px; width: 140px;
        }
        .dock-btn:hover { background-color: #0078D4; border-color: #0078D4; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h3>üîí Team Login</h3>
            <p class="text-muted">Enter your Team GitHub Token to access the schedule.</p>
            <input type="password" id="api-token" class="form-control mb-3" placeholder="ghp_...">
            <button onclick="login()" class="btn btn-primary w-100">Access Schedule</button>
        </div>
    </div>

    <div id="app-container" style="display:none;">
        <div class="d-flex justify-content-between align-items-center px-4 pt-2">
            <h5 class="text-muted">
                Controls & Automation Scheduler 
                <span class="badge bg-primary" style="font-size: 0.6em;">v6.0</span>
                <span id="loading-spinner" class="spinner-border spinner-border-sm text-primary" role="status"></span>
            </h5>
        </div>

        <div id="calendar"></div>
        
        <div class="bottom-dock">
            <button class="dock-btn" onclick="openEventModal()">‚ûï Add Item</button>
            <button class="dock-btn" onclick="openFilterModal()">üîç Filter</button>
            <button class="dock-btn" onclick="openTeamManager()">üë• Team</button>
            <button class="dock-btn" onclick="openTypeManager()">üé® Types</button>
            <button class="dock-btn" onclick="location.reload()">üîÑ Refresh</button>
        </div>
    </div>

    <div class="modal fade" id="filterModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Filter Team View</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="d-flex justify-content-between mb-3">
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleAllFilters(true)">Select All</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleAllFilters(false)">Clear All</button>
                    </div>
                    <div id="filter-list" class="grid-list"></div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-primary w-100" onclick="applyFilters()">Apply Filters</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="eventModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="eventModalTitle">Schedule Item</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="evt-id">
                    
                    <label class="small text-muted mb-1">Project Name</label>
                    <input type="text" id="evt-title" class="form-control mb-4 bg-dark text-white" style="font-size: 1.1em;" placeholder="e.g. Line 4 Commissioning">
                    
                    <div class="row g-3 mb-4">
                        <div class="col-7">
                            <label class="small text-muted mb-1">Assign Members</label>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start text-white bg-dark p-2" type="button" id="multiSelectBtn" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                                    Select Members...
                                </button>
                                <ul class="dropdown-menu w-100 bg-dark border-secondary grid-list" id="member-checkbox-list" style="width: 100% !important; min-width: 400px; max-height: 400px;"></ul>
                            </div>
                        </div>
                        <div class="col-5">
                            <label class="small text-muted mb-1">Activity Type</label>
                            <select id="evt-type" class="form-select bg-dark text-white p-2"></select>
                        </div>
                    </div>
                    
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="all-day-switch" checked onchange="toggleTimeInputs()">
                        <label class="form-check-label text-muted" for="all-day-switch">All Day Event</label>
                    </div>

                    <label class="small text-muted mb-1">Date Range</label>
                    <input type="text" id="date-range-picker" class="form-control mb-3 bg-dark text-white p-2" placeholder="Select dates...">

                    <div id="time-inputs-container" class="mb-4" style="display:none; position: relative;">
                        <label class="small text-muted mb-1">Time Range</label>
                        <input type="text" id="time-range-display" class="form-control bg-dark text-white p-2 text-center" placeholder="Select time..." readonly style="cursor: pointer;">
                        <div id="custom-time-dropdown" class="time-picker-dropdown"></div>
                    </div>

                    <div class="d-flex gap-2 mt-2">
                        <button onclick="prepareSaveEvent()" class="btn btn-primary flex-grow-1 p-2 fw-bold">Save Item</button>
                        <button onclick="confirmDeleteEvent()" id="btn-delete-event" class="btn btn-danger p-2" style="display:none;">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="conflictModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-warning">
                <div class="modal-header border-secondary bg-warning text-dark">
                    <h5 class="modal-title">‚ö†Ô∏è Schedule Conflicts Detected</h5>
                </div>
                <div class="modal-body p-4">
                    <p style="font-size: 1.1em;">The following team members are already booked:</p>
                    <ul id="conflict-list" class="list-group list-group-flush mb-4" style="max-height: 300px; overflow-y: auto;"></ul>
                    <p class="small text-muted">Do you want to double-book them?</p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary p-2 px-4" data-bs-dismiss="modal">Go Back</button>
                    <button type="button" class="btn btn-warning p-2 px-4" onclick="confirmForceSave()">Save Anyway</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="teamModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Manage Team</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="input-group mb-4">
                        <input type="text" id="new-member-name" class="form-control bg-dark text-white p-2" placeholder="New Member Name">
                        <button onclick="handleMemberSubmit()" id="btn-team-submit" class="btn btn-success px-4">Add</button>
                        <button onclick="cancelTeamEdit()" id="btn-team-cancel" class="btn btn-secondary px-3" style="display:none;">‚úï</button>
                    </div>
                    <div id="team-list" class="grid-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="typeModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Manage Activity Types</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="input-group mb-4">
                        <input type="text" id="new-type-name" class="form-control bg-dark text-white p-2" placeholder="Type Name">
                        <input type="color" id="new-type-color" class="form-control form-control-color bg-dark border-secondary" value="#0d6efd" style="height: 42px; width: 60px;">
                        <button onclick="handleTypeSubmit()" id="btn-type-submit" class="btn btn-success px-4">Add</button>
                        <button onclick="cancelTypeEdit()" id="btn-type-cancel" class="btn btn-secondary px-3" style="display:none;">‚úï</button>
                    </div>
                    <div id="type-list" class="grid-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="alertModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary"><h5 class="modal-title">Notice</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body p-4"><p id="alert-message"></p></div>
                <div class="modal-footer border-secondary"><button type="button" class="btn btn-primary w-100" data-bs-dismiss="modal">OK</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary"><h5 class="modal-title">Confirm Action</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body p-4"><p id="confirm-message"></p></div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="btn-confirm-action">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const REPO_OWNER = "controlswmi-pixel"; 
        const REPO_NAME = "Controls-Calendar"; 
        const SCHEDULE_FILE = "schedule.json";
        const TEAM_FILE = "team.json";
        const TYPES_FILE = "types.json"; 
        
        const DEFAULT_TYPES = [
            { name: "Panel Build", color: "#0078D4" },
            { name: "Vacation", color: "#107C10" },
            { name: "On-Site Startup", color: "#D13438" },
            { name: "Office Day", color: "#FF8C00" },
            { name: "Maintenance", color: "#881798" }
        ];

        let octokit = null; let calendar = null; let fpDate = null;
        let scheduleData = []; let scheduleSha = null;
        let teamData = []; let teamSha = null;
        let typeData = []; let typeSha = null;
        let editingTeamIndex = -1; let editingTypeIndex = -1;
        let pendingSaveData = null; let activeFilters = []; 
        let timeOptions = []; let rangeStartIndex = -1; let rangeEndIndex = -1;

        document.addEventListener('DOMContentLoaded', () => {
            const storedToken = localStorage.getItem('gh_token');
            if (storedToken) { document.getElementById('api-token').value = storedToken; login(); }
            
            fpDate = flatpickr("#date-range-picker", { mode: "range", dateFormat: "Y-m-d", theme: "dark", minDate: "today" });
            generateTimeOptions(); setupTimePickerEvents();
        });

        function generateTimeOptions() {
            const dropdown = document.getElementById('custom-time-dropdown'); dropdown.innerHTML = ""; timeOptions = [];
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 15) {
                    const ampm = h >= 12 ? 'PM' : 'AM'; const h12 = h % 12 || 12; const mStr = m.toString().padStart(2, '0');
                    const timeStr = `${h12}:${mStr} ${ampm}`; const val = h * 60 + m;
                    timeOptions.push({ text: timeStr, value: val });
                    const div = document.createElement('div'); div.className = 'time-option'; div.innerText = timeStr;
                    div.dataset.index = timeOptions.length - 1;
                    div.onclick = (e) => handleTimeOptionClick(parseInt(e.target.dataset.index));
                    div.onmouseover = (e) => handleTimeOptionHover(parseInt(e.target.dataset.index));
                    dropdown.appendChild(div);
                }
            }
        }

        function setupTimePickerEvents() {
            const display = document.getElementById('time-range-display');
            const dropdown = document.getElementById('custom-time-dropdown');
            display.addEventListener('click', () => {
                const isHidden = dropdown.style.display === 'none' || dropdown.style.display === '';
                dropdown.style.display = isHidden ? 'grid' : 'none';
                if(isHidden) { const target = dropdown.children[32]; if(target) target.scrollIntoView({ block: "center" }); }
            });
            document.addEventListener('click', (e) => {
                if (!display.contains(e.target) && !dropdown.contains(e.target)) { dropdown.style.display = 'none'; }
            });
        }

        function handleTimeOptionClick(index) {
            const options = document.querySelectorAll('.time-option');
            if (rangeStartIndex === -1 || (rangeStartIndex !== -1 && rangeEndIndex !== -1)) {
                rangeStartIndex = index; rangeEndIndex = -1; resetTimeStyles(); options[index].classList.add('selected');
            } else {
                if (index < rangeStartIndex) { rangeStartIndex = index; resetTimeStyles(); options[index].classList.add('selected'); }
                else { rangeEndIndex = index; options[index].classList.add('selected'); updateTimeDisplay(); document.getElementById('custom-time-dropdown').style.display = 'none'; }
            }
        }

        function handleTimeOptionHover(index) {
            if (rangeStartIndex !== -1 && rangeEndIndex === -1) {
                const options = document.querySelectorAll('.time-option');
                options.forEach((opt, i) => {
                    if (i > rangeStartIndex && i <= index) { opt.classList.add('in-range'); } else { opt.classList.remove('in-range'); }
                });
            }
        }

        function resetTimeStyles() { document.querySelectorAll('.time-option').forEach(opt => { opt.classList.remove('selected', 'in-range'); }); }
        function updateTimeDisplay() {
            if (rangeStartIndex !== -1 && rangeEndIndex !== -1) {
                document.getElementById('time-range-display').value = `${timeOptions[rangeStartIndex].text} - ${timeOptions[rangeEndIndex].text}`;
            }
        }

        function toggleTimeInputs() {
            const isAllDay = document.getElementById('all-day-switch').checked;
            document.getElementById('time-inputs-container').style.display = isAllDay ? 'none' : 'block';
        }

        async function login() {
            const token = document.getElementById('api-token').value.trim();
            if (!token) return showAlert("Please enter a token");
            try {
                const { Octokit } = window; octokit = new Octokit({ auth: token });
                const user = await octokit.request('GET /user');
                localStorage.setItem('gh_token', token);
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                initApp();
            } catch (e) { showAlert("Invalid Token: " + e.message); localStorage.removeItem('gh_token'); }
        }

        async function initApp() {
            showSpinner();
            await Promise.all([loadTeam(), loadTypes(), loadSchedule()]);
            activeFilters = [...teamData];
            let migrationNeeded = false;
            scheduleData.forEach(ev => { if (!ev.id) { ev.id = crypto.randomUUID(); migrationNeeded = true; } });
            if (migrationNeeded) await saveFile(SCHEDULE_FILE, scheduleData, scheduleSha);
            hideSpinner(); initCalendar();
        }

        function showSpinner() { document.getElementById('loading-spinner').style.display = 'inline-block'; }
        function hideSpinner() { document.getElementById('loading-spinner').style.display = 'none'; }
        function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
        function b64_to_utf8(str) { try { return decodeURIComponent(escape(window.atob(str))); } catch (e) { return window.atob(str); } }
        function showAlert(message) { document.getElementById('alert-message').innerText = message; new bootstrap.Modal(document.getElementById('alertModal')).show(); }
        function showConfirm(message, onConfirm) {
            document.getElementById('confirm-message').innerText = message;
            const confirmBtn = document.getElementById('btn-confirm-action');
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
            newBtn.addEventListener('click', () => { onConfirm(); bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide(); });
            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }

        function formatDateForDisplay(dateStr) {
            if (!dateStr) return "";
            // Check if string is ISO (contains T) or YYYY-MM-DD
            if (dateStr.includes('T')) {
                const date = new Date(dateStr);
                return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true });
            } else {
                // All Day Event (YYYY-MM-DD) - Append time 
                // We create date in local timezone to avoid off-by-one errors with UTC
                const [y, m, d] = dateStr.split('-');
                const date = new Date(y, m-1, d); 
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }
        }

        async function getFile(filename) {
            try { const t = new Date().getTime(); const r = await octokit.request(`GET /repos/${REPO_OWNER}/${REPO_NAME}/contents/${filename}?t=${t}`, { owner: REPO_OWNER, repo: REPO_NAME, path: filename }); return { content: JSON.parse(b64_to_utf8(r.data.content)), sha: r.data.sha }; } catch (e) { return { content: null, sha: null }; }
        }
        async function saveFile(filename, content, sha) {
            showSpinner();
            if (!sha) { try { const c = await octokit.request(`GET /repos/${REPO_OWNER}/${REPO_NAME}/contents/${filename}`, { owner: REPO_OWNER, repo: REPO_NAME, path: filename }); sha = c.data.sha; } catch (e) {} }
            const params = { owner: REPO_OWNER, repo: REPO_NAME, path: filename, message: "Update", content: utf8_to_b64(JSON.stringify(content, null, 2)) };
            if (sha) params.sha = sha;
            try { const r = await octokit.request(`PUT /repos/${REPO_OWNER}/${REPO_NAME}/contents/${filename}`, params); hideSpinner(); return r.data.content.sha; } catch (e) { hideSpinner(); showAlert("Save Error: " + e.message); throw e; }
        }
        async function loadTeam() { const d = await getFile(TEAM_FILE); teamData = d.content || []; teamSha = d.sha; }
        async function loadTypes() { const d = await getFile(TYPES_FILE); typeData = d.content || DEFAULT_TYPES; typeSha = d.sha; }
        async function loadSchedule() { const d = await getFile(SCHEDULE_FILE); scheduleData = d.content || []; scheduleSha = d.sha; }

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listMonth' }, events: scheduleData, height: '80vh', themeSystem: 'bootstrap5', editable: true, droppable: true, eventResizableFromStart: true, eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short' },
                eventClick: function(info) { openEventModal(info.event); },
                eventDrop: async function(info) { await handleDragResize(info.event); },
                eventResize: async function(info) { await handleDragResize(info.event); },
                // Custom List View Rendering (Card Style)
                eventDidMount: function(info) {
                    if (info.view.type === 'listMonth') {
                        // Apply colored border based on type
                        info.el.style.borderLeft = `5px solid ${info.event.backgroundColor}`;
                        info.el.querySelector('.fc-list-event-dot').style.display = 'none'; // Hide default dot
                    }
                },
                eventContent: function(arg) {
                    let members = (arg.event.extendedProps && arg.event.extendedProps.members) ? arg.event.extendedProps.members : (arg.event.resourceId ? [arg.event.resourceId] : []);
                    return { html: `<div><span class="event-title">${arg.event.title}</span><span class="event-members">${members.join(", ")}</span></div>` };
                }
            });
            calendar.render(); refreshCalendarEvents();
        }

        async function handleDragResize(event) {
            const index = scheduleData.findIndex(e => e.id === event.id);
            if (index > -1) {
                if (event.allDay) { scheduleData[index].start = event.startStr; scheduleData[index].end = event.endStr; scheduleData[index].allDay = true; } 
                else { scheduleData[index].start = event.start.toISOString(); scheduleData[index].end = event.end.toISOString(); scheduleData[index].allDay = false; }
                scheduleSha = await saveFile(SCHEDULE_FILE, scheduleData, scheduleSha);
            }
        }

        function openFilterModal() {
            const list = document.getElementById('filter-list'); list.innerHTML = "";
            teamData.forEach(member => {
                const isChecked = activeFilters.includes(member) ? "checked" : "";
                const div = document.createElement("div"); div.className = "grid-item form-check"; 
                div.innerHTML = `<label class="filter-label text-white"><input class="form-check-input me-2" type="checkbox" value="${member}" ${isChecked}>${member}</label>`;
                list.appendChild(div);
            });
            new bootstrap.Modal(document.getElementById('filterModal')).show();
        }
        function toggleAllFilters(selectAll) { document.querySelectorAll('.filter-label input[type="checkbox"]').forEach(cb => cb.checked = selectAll); }
        function applyFilters() {
            const checkboxes = document.querySelectorAll('#filter-list input[type="checkbox"]:checked');
            activeFilters = Array.from(checkboxes).map(cb => cb.value);
            refreshCalendarEvents(); bootstrap.Modal.getInstance(document.getElementById('filterModal')).hide();
        }
        function refreshCalendarEvents() {
            if (!calendar) return;
            const visibleEvents = scheduleData.filter(event => {
                const members = event.extendedProps.members || (event.resourceId ? [event.resourceId] : []);
                if (members.length === 0) return true;
                return members.some(m => activeFilters.includes(m));
            });
            calendar.removeAllEvents(); calendar.addEventSource(visibleEvents);
        }

        function openEventModal(event = null) {
            const list = document.getElementById('member-checkbox-list'); list.innerHTML = "";
            teamData.forEach(member => {
                const li = document.createElement("li"); li.style.listStyle = "none"; li.className = "grid-item";
                li.innerHTML = `<label class="dropdown-item-checkbox text-white"><input type="checkbox" class="form-check-input me-2 member-check" value="${member}">${member}</label>`;
                list.appendChild(li);
            });
            const typeSelect = document.getElementById('evt-type'); typeSelect.innerHTML = "";
            typeData.forEach(type => { const opt = document.createElement("option"); opt.value = type.color; opt.innerText = type.name; opt.setAttribute('data-name', type.name); typeSelect.appendChild(opt); });

            if (event) {
                document.getElementById('eventModalTitle').innerText = "Edit Schedule Item";
                document.getElementById('evt-id').value = event.id; document.getElementById('evt-title').value = event.title;
                document.getElementById('btn-delete-event').style.display = "block";
                const typeName = event.extendedProps.type;
                const typeOpt = Array.from(typeSelect.options).find(opt => opt.getAttribute('data-name') === typeName);
                if (typeOpt) typeSelect.value = typeOpt.value;
                const members = event.extendedProps.members || [];
                document.querySelectorAll('.member-check').forEach(box => { if (members.includes(box.value)) box.checked = true; });
                const isAllDay = event.allDay;
                document.getElementById('all-day-switch').checked = isAllDay;
                let displayEnd = event.end;
                if (isAllDay && displayEnd) { displayEnd = new Date(displayEnd); displayEnd.setDate(displayEnd.getDate() - 1); }
                fpDate.setDate([event.start, displayEnd]);
                if (!isAllDay && event.start && event.end) {
                    const s = event.start; const e = event.end;
                    rangeStartIndex = timeOptions.findIndex(t => t.value === (s.getHours() * 60 + s.getMinutes()));
                    rangeEndIndex = timeOptions.findIndex(t => t.value === (e.getHours() * 60 + e.getMinutes()));
                    resetTimeStyles();
                    if(rangeStartIndex > -1) document.querySelectorAll('.time-option')[rangeStartIndex].classList.add('selected');
                    if(rangeEndIndex > -1) { document.querySelectorAll('.time-option')[rangeEndIndex].classList.add('selected'); handleTimeOptionHover(rangeEndIndex); }
                    updateTimeDisplay();
                } else { rangeStartIndex = -1; rangeEndIndex = -1; document.getElementById('time-range-display').value = ""; resetTimeStyles(); }
                toggleTimeInputs();
            } else {
                document.getElementById('eventModalTitle').innerText = "New Schedule Item";
                document.getElementById('evt-id').value = ""; document.getElementById('evt-title').value = "";
                document.getElementById('btn-delete-event').style.display = "none";
                document.getElementById('all-day-switch').checked = true; toggleTimeInputs(); fpDate.clear();
                rangeStartIndex = -1; rangeEndIndex = -1; document.getElementById('time-range-display').value = ""; resetTimeStyles();
            }
            document.querySelectorAll('.member-check').forEach(box => box.addEventListener('change', updateSelectedCount));
            updateSelectedCount(); new bootstrap.Modal(document.getElementById('eventModal')).show();
        }

        function updateSelectedCount() {
            const checked = document.querySelectorAll('.member-check:checked');
            const btn = document.getElementById('multiSelectBtn');
            if (checked.length === 0) btn.innerText = "Select Members...";
            else if (checked.length === 1) btn.innerText = checked[0].value;
            else btn.innerText = `${checked.length} Members Selected`;
        }

        async function prepareSaveEvent() {
            const id = document.getElementById('evt-id').value;
            const title = document.getElementById('evt-title').value;
            const typeSelect = document.getElementById('evt-type');
            const color = typeSelect.value;
            const typeName = typeSelect.options[typeSelect.selectedIndex].getAttribute('data-name');
            const isAllDay = document.getElementById('all-day-switch').checked;
            const selectedDates = fpDate.selectedDates;
            if (!selectedDates || selectedDates.length < 2) return showAlert("Select Date Range.");
            let startISO, endISO;
            const baseStartDate = selectedDates[0]; const baseEndDate = selectedDates[1];
            if (isAllDay) {
                startISO = fpDate.formatDate(baseStartDate, "Y-m-d");
                let endDateEx = new Date(baseEndDate); endDateEx.setDate(endDateEx.getDate() + 1);
                endISO = endDateEx.toISOString().split('T')[0];
            } else {
                if (rangeStartIndex === -1 || rangeEndIndex === -1) return showAlert("Select Time Range.");
                const startMins = timeOptions[rangeStartIndex].value; const endMins = timeOptions[rangeEndIndex].value;
                let startFull = new Date(baseStartDate); startFull.setHours(Math.floor(startMins / 60), startMins % 60);
                let endFull = new Date(baseEndDate); endFull.setHours(Math.floor(endMins / 60), endMins % 60);
                startISO = startFull.toISOString(); endISO = endFull.toISOString();
            }
            const checkboxes = document.querySelectorAll('.member-check:checked');
            const selectedMembers = Array.from(checkboxes).map(cb => cb.value);
            if (!title || selectedMembers.length === 0) return showAlert("Title and Members required.");
            pendingSaveData = { id: id || crypto.randomUUID(), title: title, start: startISO, end: endISO, allDay: isAllDay, backgroundColor: color, borderColor: color, extendedProps: { type: typeName, members: selectedMembers } };
            const newStart = new Date(startISO); const newEnd = new Date(endISO);
            let conflicts = [];
            for (let event of scheduleData) {
                if (id && event.id === id) continue; if (!event.start || !event.end) continue;
                const evStart = new Date(event.start); const evEnd = new Date(event.end);
                if (newStart < evEnd && newEnd > evStart) {
                    const existingGroup = event.extendedProps.members || (event.resourceId ? [event.resourceId] : []);
                    const overlaps = selectedMembers.filter(m => existingGroup.includes(m));
                    if (overlaps.length > 0) {
                        overlaps.forEach(person => {
                            const displayStart = formatDateForDisplay(event.start); const displayEnd = formatDateForDisplay(event.end);
                            conflicts.push(`<b>${person}</b> is busy with "<i>${event.title}</i>" (${displayStart} - ${displayEnd})`);
                        });
                    }
                }
            }
            if (conflicts.length > 0) {
                const conflictList = document.getElementById('conflict-list'); conflictList.innerHTML = "";
                conflicts.forEach(c => { const li = document.createElement("li"); li.className = "list-group-item bg-dark text-white border-secondary"; li.innerHTML = c; conflictList.appendChild(li); });
                new bootstrap.Modal(document.getElementById('conflictModal')).show();
            } else { finalizeSave(); }
        }

        function confirmForceSave() { bootstrap.Modal.getInstance(document.getElementById('conflictModal')).hide(); finalizeSave(); }
        async function finalizeSave() {
            if (!pendingSaveData) return;
            const eventObj = pendingSaveData;
            const index = scheduleData.findIndex(e => e.id === eventObj.id);
            if (index > -1) { scheduleData[index] = eventObj; } else { scheduleData.push(eventObj); }
            refreshCalendarEvents(); bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
            scheduleSha = await saveFile(SCHEDULE_FILE, scheduleData, scheduleSha); pendingSaveData = null;
        }
        function confirmDeleteEvent() { showConfirm("Delete this item?", deleteEvent); }
        async function deleteEvent() {
            const id = document.getElementById('evt-id').value; if (!id) return;
            const index = scheduleData.findIndex(e => e.id === id);
            if (index > -1) { scheduleData.splice(index, 1); refreshCalendarEvents(); bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide(); scheduleSha = await saveFile(SCHEDULE_FILE, scheduleData, scheduleSha); }
        }

        function openTeamManager() { cancelTeamEdit(); renderTeamList(); new bootstrap.Modal(document.getElementById('teamModal')).show(); }
        function renderTeamList() {
            const list = document.getElementById('team-list'); list.innerHTML = "";
            teamData.forEach((member, index) => {
                const li = document.createElement("div"); li.className = "grid-item";
                li.innerHTML = `<span class="name-truncate" title="${member}">üë§ ${member}</span> <div style="flex-shrink:0;"><button class="btn btn-sm btn-outline-warning btn-icon" onclick="startEditMember(${index})">‚úèÔ∏è</button><button class="btn btn-sm btn-outline-danger btn-icon" onclick="confirmRemoveMember(${index})">üóëÔ∏è</button></div>`;
                list.appendChild(li);
            });
        }
        function startEditMember(index) { editingTeamIndex = index; document.getElementById('new-member-name').value = teamData[index]; document.getElementById('btn-team-submit').innerText = "Update"; document.getElementById('btn-team-submit').className = "btn btn-warning px-4"; document.getElementById('btn-team-cancel').style.display = "inline-block"; }
        function cancelTeamEdit() { editingTeamIndex = -1; document.getElementById('new-member-name').value = ""; document.getElementById('btn-team-submit').innerText = "Add"; document.getElementById('btn-team-submit').className = "btn btn-success px-4"; document.getElementById('btn-team-cancel').style.display = "none"; }
        async function handleMemberSubmit() {
            const name = document.getElementById('new-member-name').value.trim(); if (!name) return;
            if (editingTeamIndex > -1) {
                const oldName = teamData[editingTeamIndex]; teamData[editingTeamIndex] = name; teamData.sort();
                let scheduleChanged = false;
                scheduleData.forEach(ev => { let mems = (ev.extendedProps && ev.extendedProps.members) ? ev.extendedProps.members : []; if (mems.includes(oldName)) { ev.extendedProps.members = mems.map(m => m === oldName ? name : m); scheduleChanged = true; } });
                renderTeamList(); cancelTeamEdit(); teamSha = await saveFile(TEAM_FILE, teamData, teamSha);
                if (scheduleChanged) { scheduleSha = await saveFile(SCHEDULE_FILE, scheduleData, scheduleSha); refreshCalendarEvents(); }
            } else { if (!teamData.includes(name)) { teamData.push(name); teamData.sort(); renderTeamList(); document.getElementById('new-member-name').value = ""; teamSha = await saveFile(TEAM_FILE, teamData, teamSha); } }
        }
        function confirmRemoveMember(index) { showConfirm(`Remove ${teamData[index]}?`, () => removeMember(index)); }
        async function removeMember(index) { teamData.splice(index, 1); renderTeamList(); teamSha = await saveFile(TEAM_FILE, teamData, teamSha); }

        function openTypeManager() { cancelTypeEdit(); renderTypeList(); new bootstrap.Modal(document.getElementById('typeModal')).show(); }
        function renderTypeList() {
            const list = document.getElementById('type-list'); list.innerHTML = "";
            typeData.forEach((type, index) => {
                const li = document.createElement("div"); li.className = "grid-item";
                li.innerHTML = `<div class="d-flex align-items-center"><span class="color-swatch" style="background-color:${type.color};"></span><span style="font-size: 1.1em;">${type.name}</span></div><div><button class="btn btn-sm btn-outline-warning btn-icon" onclick="startEditType(${index})">‚úèÔ∏è</button><button class="btn btn-sm btn-outline-danger btn-icon" onclick="confirmRemoveType(${index})">üóëÔ∏è</button></div>`;
                list.appendChild(li);
            });
        }
        function startEditType(index) { editingTypeIndex = index; const type = typeData[index]; document.getElementById('new-type-name').value = type.name; document.getElementById('new-type-color').value = type.color; document.getElementById('btn-type-submit').innerText = "Update"; document.getElementById('btn-type-submit').className = "btn btn-warning px-4"; document.getElementById('btn-type-cancel').style.display = "inline-block"; }
        function cancelTypeEdit() { editingTypeIndex = -1; document.getElementById('new-type-name').value = ""; document.getElementById('new-type-color').value = "#0d6efd"; document.getElementById('btn-type-submit').innerText = "Add"; document.getElementById('btn-type-submit').className = "btn btn-success px-4"; document.getElementById('btn-type-cancel').style.display = "none"; }
        async function handleTypeSubmit() {
            const name = document.getElementById('new-type-name').value.trim(); const color = document.getElementById('new-type-color').value; if (!name) return;
            if (editingTypeIndex > -1) {
                const oldType = typeData[editingTypeIndex]; const oldName = oldType.name; typeData[editingTypeIndex] = { name: name, color: color };
                let scheduleChanged = false;
                scheduleData.forEach(ev => { if (ev.extendedProps && ev.extendedProps.type === oldName) { ev.extendedProps.type = name; ev.backgroundColor = color; ev.borderColor = color; scheduleChanged = true; } });
                renderTypeList(); cancelTypeEdit(); typeSha = await saveFile(TYPES_FILE, typeData, typeSha);
                if (scheduleChanged) { scheduleSha = await saveFile(SCHEDULE_FILE, scheduleData, scheduleSha); refreshCalendarEvents(); }
            } else { if (!typeData.some(t => t.name === name)) { typeData.push({ name: name, color: color }); renderTypeList(); document.getElementById('new-type-name').value = ""; typeSha = await saveFile(TYPES_FILE, typeData, typeSha); } }
        }
        function confirmRemoveType(index) { showConfirm(`Delete activity type "${typeData[index].name}"?`, () => removeType(index)); }
        async function removeType(index) { typeData.splice(index, 1); renderTypeList(); typeSha = await saveFile(TYPES_FILE, typeData, typeSha); }
    </script>
</body>
</html>
