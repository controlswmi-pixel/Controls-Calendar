<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controls Team Scheduler</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";
        window.Octokit = Octokit;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body { background-color: #0e1117; color: white; padding-bottom: 80px; }
        .fc { height: 85vh; margin: 20px; }
        .fc-toolbar-title { font-size: 1.5rem !important; }
        .fc-event { cursor: pointer; border: none; }
        
        /* Bottom Dock */
        .bottom-dock {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #1a1b21; border-top: 1px solid #333;
            padding: 15px; display: flex; gap: 10px; justify-content: center;
            z-index: 1000;
        }
        .dock-btn {
            background-color: #262730; border: 1px solid #444; color: white;
            font-weight: 600; padding: 10px 20px; border-radius: 8px; width: 150px;
        }
        .dock-btn:hover { background-color: #0078D4; border-color: #0078D4; }

        /* Login Overlay */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0e1117; z-index: 2000; display: flex;
            align-items: center; justify-content: center;
        }
        .login-box {
            background: #1a1b21; padding: 30px; border-radius: 10px;
            border: 1px solid #333; width: 400px;
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h3>üîí Team Login</h3>
            <p class="text-muted">Enter your Team GitHub Token to access the schedule.</p>
            <input type="password" id="api-token" class="form-control mb-3" placeholder="ghp_...">
            <button onclick="login()" class="btn btn-primary w-100">Access Schedule</button>
        </div>
    </div>

    <div id="app-container" style="display:none;">
        <div id="calendar"></div>
        
        <div class="bottom-dock">
            <button class="dock-btn" data-bs-toggle="modal" data-bs-target="#addEventModal">‚ûï Add Item</button>
            <button class="dock-btn" onclick="openTeamManager()">üë• Team</button>
            <button class="dock-btn" onclick="location.reload()">üîÑ Refresh</button>
        </div>
    </div>

    <div class="modal fade" id="addEventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">New Schedule Item</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="evt-title" class="form-control mb-3 bg-dark text-white" placeholder="Project / Description">
                    <div class="row g-2 mb-3">
                        <div class="col-7"><select id="evt-assignee" class="form-select bg-dark text-white"></select></div>
                        <div class="col-5"><select id="evt-type" class="form-select bg-dark text-white">
                            <option value="#0078D4">Panel Build</option>
                            <option value="#107C10">Vacation</option>
                            <option value="#D13438">On-Site Startup</option>
                            <option value="#FF8C00">Office Day</option>
                            <option value="#881798">Maintenance</option>
                        </select></div>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><input type="date" id="evt-start" class="form-control bg-dark text-white"></div>
                        <div class="col-6"><input type="date" id="evt-end" class="form-control bg-dark text-white"></div>
                    </div>
                    <button onclick="saveEvent()" class="btn btn-primary w-100">Save Item</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="teamModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Manage Team</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" id="new-member-name" class="form-control bg-dark text-white" placeholder="New Member Name">
                        <button onclick="addMember()" class="btn btn-success">Add</button>
                    </div>
                    <ul id="team-list" class="list-group list-group-flush"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const REPO_OWNER = "controlswmi-pixel"; // CHANGE THIS IF NEEDED
        const REPO_NAME = "Controls-Calendar";  // CHANGE THIS IF NEEDED
        const SCHEDULE_FILE = "schedule.json";
        const TEAM_FILE = "team.json";
        
        // --- STATE ---
        let octokit = null;
        let calendar = null;
        let scheduleData = [];
        let scheduleSha = null;
        let teamData = [];
        let teamSha = null;

        // --- AUTH ---
        document.addEventListener('DOMContentLoaded', () => {
            const storedToken = localStorage.getItem('gh_token');
            if (storedToken) {
                document.getElementById('api-token').value = storedToken;
                login();
            }
            // Set default dates
            document.getElementById('evt-start').valueAsDate = new Date();
            document.getElementById('evt-end').valueAsDate = new Date();
        });

        async function login() {
            const token = document.getElementById('api-token').value.trim();
            if (!token) return alert("Please enter a token");
            
            try {
                // Initialize Octokit
                const { Octokit } = window;
                octokit = new Octokit({ auth: token });
                
                // Test connection
                const user = await octokit.request('GET /user');
                console.log("Logged in as:", user.data.login);
                
                localStorage.setItem('gh_token', token);
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                
                initApp();
            } catch (e) {
                alert("Invalid Token or Connection Error: " + e.message);
                localStorage.removeItem('gh_token');
            }
        }

        async function initApp() {
            await loadTeam();
            await loadSchedule();
            initCalendar();
        }

        // --- GITHUB API HELPERS ---
        async function getFile(filename) {
            try {
                const response = await octokit.request(`GET /repos/${REPO_OWNER}/${REPO_NAME}/contents/${filename}`, {
                    owner: REPO_OWNER, repo: REPO_NAME, path: filename
                });
                return {
                    content: JSON.parse(atob(response.data.content)),
                    sha: response.data.sha
                };
            } catch (e) {
                console.log(`${filename} not found, returning empty.`);
                return { content: [], sha: null };
            }
        }

        async function saveFile(filename, content, sha) {
            try {
                const response = await octokit.request(`PUT /repos/${REPO_OWNER}/${REPO_NAME}/contents/${filename}`, {
                    owner: REPO_OWNER, repo: REPO_NAME, path: filename,
                    message: "Update via Web App",
                    content: btoa(JSON.stringify(content, null, 2)),
                    sha: sha
                });
                return response.data.content.sha;
            } catch (e) {
                alert("Error saving: " + e.message);
                throw e;
            }
        }

        // --- DATA LOADING ---
        async function loadTeam() {
            const data = await getFile(TEAM_FILE);
            teamData = data.content.length ? data.content : ["Carson", "Dave Miller"]; // Default
            teamSha = data.sha;
            
            // Populate Dropdown
            const select = document.getElementById('evt-assignee');
            select.innerHTML = "";
            teamData.forEach(member => {
                const opt = document.createElement("option");
                opt.value = member;
                opt.innerText = member;
                select.appendChild(opt);
            });
        }

        async function loadSchedule() {
            const data = await getFile(SCHEDULE_FILE);
            scheduleData = data.content;
            scheduleSha = data.sha;
        }

        // --- CALENDAR ---
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listMonth' },
                events: scheduleData,
                height: '85vh',
                themeSystem: 'bootstrap5'
            });
            calendar.render();
        }

        // --- ACTIONS ---
        async function saveEvent() {
            const title = document.getElementById('evt-title').value;
            const assignee = document.getElementById('evt-assignee').value;
            const color = document.getElementById('evt-type').value;
            const start = document.getElementById('evt-start').value;
            let end = document.getElementById('evt-end').value;

            if (!title || !start || !end) return alert("Please fill all fields");
            
            // Fix End Date (FullCalendar is exclusive)
            let endDateObj = new Date(end);
            endDateObj.setDate(endDateObj.getDate() + 1);
            const adjEnd = endDateObj.toISOString().split('T')[0];

            const newEvent = {
                title: `${assignee}: ${title}`,
                start: start,
                end: adjEnd,
                backgroundColor: color,
                borderColor: color,
                resourceId: assignee
            };
            
            // Optimistic UI Update
            calendar.addEvent(newEvent);
            const modal = bootstrap.Modal.getInstance(document.getElementById('addEventModal'));
            modal.hide();

            // Save to GitHub
            scheduleData.push(newEvent);
            scheduleSha = await saveFile(SCHEDULE_FILE, scheduleData, scheduleSha);
        }

        // --- TEAM MANAGER ---
        function openTeamManager() {
            renderTeamList();
            new bootstrap.Modal(document.getElementById('teamModal')).show();
        }

        function renderTeamList() {
            const list = document.getElementById('team-list');
            list.innerHTML = "";
            teamData.forEach((member, index) => {
                const li = document.createElement("li");
                li.className = "list-group-item bg-dark text-white d-flex justify-content-between align-items-center border-secondary";
                li.innerHTML = `
                    <span>üë§ ${member}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeMember(${index})">üóëÔ∏è</button>
                `;
                list.appendChild(li);
            });
        }

        async function addMember() {
            const name = document.getElementById('new-member-name').value;
            if (name && !teamData.includes(name)) {
                teamData.push(name);
                teamData.sort();
                renderTeamList();
                document.getElementById('new-member-name').value = "";
                teamSha = await saveFile(TEAM_FILE, teamData, teamSha);
                loadTeam(); // Update dropdowns
            }
        }

        async function removeMember(index) {
            if(confirm(`Remove ${teamData[index]}?`)) {
                teamData.splice(index, 1);
                renderTeamList();
                teamSha = await saveFile(TEAM_FILE, teamData, teamSha);
                loadTeam(); // Update dropdowns
            }
        }
    </script>
</body>
</html>
