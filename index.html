<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controls Team Scheduler v4.3</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script type="module">
        import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";
        window.Octokit = Octokit;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        body { background-color: #0e1117; color: white; padding-bottom: 80px; overflow: hidden; }
        
        /* Calendar Styling */
        .fc { height: 85vh; margin: 20px; }
        .fc-toolbar-title { font-size: 1.5rem !important; }
        
        /* Remove ugly blue underlines from dates */
        .fc a { text-decoration: none !important; color: inherit !important; }
        .fc-col-header-cell-cushion { color: white !important; } 
        .fc-daygrid-day-number { color: rgba(255, 255, 255, 0.75) !important; padding: 4px 8px !important; }
        
        /* Event Styling */
        .fc-event { cursor: pointer; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .fc-event:hover { filter: brightness(1.1); }
        .fc-event-main { padding: 4px; }
        .event-title { font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 2px; }
        .event-members { font-size: 0.75em; opacity: 0.9; display: block; line-height: 1.1; }

        /* Bottom Dock */
        .bottom-dock {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #1a1b21; border-top: 1px solid #333;
            padding: 15px; display: flex; gap: 10px; justify-content: center;
            z-index: 1000;
        }
        .dock-btn {
            background-color: #262730; border: 1px solid #444; color: white;
            font-weight: 600; padding: 10px 15px; border-radius: 8px; width: 140px;
        }
        .dock-btn:hover { background-color: #0078D4; border-color: #0078D4; }

        /* Login Overlay */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0e1117; z-index: 2000; display: flex;
            align-items: center; justify-content: center;
        }
        .login-box {
            background: #1a1b21; padding: 30px; border-radius: 10px;
            border: 1px solid #333; width: 400px;
        }

        /* Lists & Scrollbars */
        .scrollable-list { max-height: 300px; overflow-y: auto; }
        .scrollable-list::-webkit-scrollbar { width: 8px; }
        .scrollable-list::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        
        .dropdown-item-checkbox { padding: 8px 15px; cursor: pointer; display: block; }
        .dropdown-item-checkbox:hover { background-color: #333; }
        
        .color-swatch { display: inline-block; width: 15px; height: 15px; border-radius: 3px; margin-right: 8px; }
        .btn-icon { padding: 2px 6px; margin-left: 5px; }

        #loading-spinner { display: none; margin-left: 10px; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h3>üîí Team Login</h3>
            <p class="text-muted">Enter your Team GitHub Token to access the schedule.</p>
            <input type="password" id="api-token" class="form-control mb-3" placeholder="ghp_...">
            <button onclick="login()" class="btn btn-primary w-100">Access Schedule</button>
        </div>
    </div>

    <div id="app-container" style="display:none;">
        <div class="d-flex justify-content-between align-items-center px-4 pt-2">
            <h5 class="text-muted">
                Controls & Automation Scheduler 
                <span class="badge bg-success" style="font-size: 0.6em;">v4.3</span>
                <span id="loading-spinner" class="spinner-border spinner-border-sm text-primary" role="status"></span>
            </h5>
        </div>

        <div id="calendar"></div>
        
        <div class="bottom-dock">
            <button class="dock-btn" onclick="openEventModal()">‚ûï Add Item</button>
            <button class="dock-btn" onclick="openTeamManager()">üë• Team</button>
            <button class="dock-btn" onclick="openTypeManager()">üé® Types</button>
            <button class="dock-btn" onclick="location.reload()">üîÑ Refresh</button>
        </div>
    </div>

    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="eventModalTitle">Schedule Item</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="evt-id">
                    
                    <label class="small text-muted mb-1">Project Name</label>
                    <input type="text" id="evt-title" class="form-control mb-3 bg-dark text-white" placeholder="e.g. Line 4 Commissioning">
                    
                    <div class="row g-2 mb-3">
                        <div class="col-7">
                            <label class="small text-muted mb-1">Assign Members</label>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start text-white bg-dark" type="button" id="multiSelectBtn" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                                    Select Members...
                                </button>
                                <ul class="dropdown-menu w-100 bg-dark border-secondary scrollable-list" id="member-checkbox-list"></ul>
                            </div>
                        </div>
                        <div class="col-5">
                            <label class="small text-muted mb-1">Activity Type</label>
                            <select id="evt-type" class="form-select bg-dark text-white"></select>
                        </div>
                    </div>
                    
                    <label class="small text-muted mb-1">Date Range</label>
                    <input type="text" id="date-range-picker" class="form-control mb-4 bg-dark text-white" placeholder="Select dates...">

                    <div class="d-flex gap-2">
                        <button onclick="prepareSaveEvent()" class="btn btn-primary flex-grow-1">Save Item</button>
                        <button onclick="deleteEvent()" id="btn-delete-event" class="btn btn-danger" style="display:none;">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="conflictModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white border-warning">
                <div class="modal-header border-secondary bg-warning text-dark">
                    <h5 class="modal-title">‚ö†Ô∏è Schedule Conflicts Detected</h5>
                </div>
                <div class="modal-body">
                    <p>The following team members are already booked:</p>
                    <ul id="conflict-list" class="list-group list-group-flush mb-3" style="max-height: 200px; overflow-y: auto;">
                        </ul>
                    <p class="small text-muted">Do you want to double-book them?</p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Go Back</button>
                    <button type="button" class="btn btn-warning" onclick="confirmForceSave()">Save Anyway</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="teamModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Manage Team</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" id="new-member-name" class="form-control bg-dark text-white" placeholder="New Member Name">
                        <button onclick="handleMemberSubmit()" id="btn-team-submit" class="btn btn-success">Add</button>
                        <button onclick="cancelTeamEdit()" id="btn-team-cancel" class="btn btn-secondary" style="display:none;">‚úï</button>
                    </div>
                    <ul id="team-list" class="list-group list-group-flush scrollable-list"></ul>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="typeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Manage Activity Types</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" id="new-type-name" class="form-control bg-dark text-white" placeholder="Type Name">
                        <input type="color" id="new-type-color" class="form-control form-control-color bg-dark border-secondary" value="#0d6efd">
                        <button onclick="handleTypeSubmit()" id="btn-type-submit" class="btn btn-success">Add</button>
                        <button onclick="cancelTypeEdit()" id="btn-type-cancel" class="btn btn-secondary" style="display:none;">‚úï</button>
                    </div>
                    <ul id="type-list" class="list-group list-group-flush scrollable-list"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const REPO_OWNER = "controlswmi-pixel"; 
        const REPO_NAME = "Controls-Calendar"; 
        const SCHEDULE_FILE = "schedule.json";
        const TEAM_FILE = "team.json";
        const TYPES_FILE = "types.json"; 
        
        const DEFAULT_TYPES = [
            { name: "Panel Build", color: "#0078D4" },
            { name: "Vacation", color: "#107C10" },
            { name: "On-Site Startup", color: "#D13438" },
            { name: "Office Day", color: "#FF8C00" },
            { name: "Maintenance", color: "#881798" }
        ];

        // --- STATE ---
        let octokit = null;
        let calendar = null;
        let fpInstance = null;
        let scheduleData = []; let scheduleSha = null;
        let teamData = []; let teamSha = null;
        let typeData = []; let typeSha = null;
        let editingTeamIndex = -1;
        let editingTypeIndex = -1;
        
        let pendingSaveData = null; 

        // --- AUTH ---
        document.addEventListener('DOMContentLoaded', () => {
            const storedToken = localStorage.getItem('gh_token');
            if (storedToken) {
                document.getElementById('api-token').value = storedToken;
                login();
            }
            
            fpInstance = flatpickr("#date-range-picker", {
                mode: "range",
                dateFormat: "Y-m-d",
                theme: "dark",
                minDate: "today"
            });
        });

        async function login() {
            const token = document.getElementById('api-token').value.trim();
            if (!token) return alert("Please enter a token");
            try {
                const { Octokit } = window;
                octokit = new Octokit({ auth: token });
                const user = await octokit.request('GET /user');
                localStorage.setItem('gh_token', token);
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                initApp();
            } catch (e) {
                alert("Invalid Token or Connection Error: " + e.message);
                localStorage.removeItem('gh_token');
            }
        }

        async function initApp() {
            showSpinner();
            await Promise.all([loadTeam(), loadTypes(), loadSchedule()]);
            
            // Legacy Migration
            let migrationNeeded = false;
            scheduleData.forEach(ev => {
                if (!ev.id) {
                    ev.id = crypto.randomUUID();
                    migrationNeeded = true;
                }
            });
            if (migrationNeeded) {
                scheduleSha = await saveFile(SCHEDULE_FILE, scheduleData, scheduleSha);
            }
            
            hideSpinner();
            initCalendar();
        }

        // --- HELPERS ---
        function showSpinner() { document.getElementById('loading-spinner').style.display = 'inline-block'; }
        function hideSpinner() { document.getElementById('loading-spinner').style.display = 'none'; }
        function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
        function b64_to_utf8(str) { 
            try { return decodeURIComponent(escape(window.atob(str))); } 
            catch (e) { return window.atob(str); } 
        }

        // NEW: Formatter for nice dates (e.g. Feb 22, 2026)
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return "";
            // Handle ISO strings by taking just the YYYY-MM-DD part to avoid timezone confusion
            const ymd = dateStr.substring(0, 10);
            const [y, m, d] = ymd.split('-');
            const date = new Date(y, m - 1, d); // Local time constructor
            return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
        }

        async function getFile(filename) {
            try {
                const timestamp = new Date().getTime();
                const response = await octokit.request(`GET /repos/${REPO_OWNER}/${REPO_NAME}/contents/${filename}?t=${timestamp}`, {
                    owner: REPO_OWNER, repo: REPO_NAME, path: filename
                });
                return {
                    content: JSON.parse(b64_to_utf8(response.data.content)),
                    sha: response.data.sha
                };
            } catch (e) {
                return { content: null, sha: null };
            }
        }

        async function saveFile(filename, content, sha) {
            showSpinner();
            if (!sha) {
                try {
                    const check = await octokit.request(`GET /repos/${REPO_OWNER}/${REPO_NAME}/contents/${filename}`, {
                        owner: REPO_OWNER, repo: REPO_NAME, path: filename
                    });
                    sha = check.data.sha;
                } catch (e) {}
            }
            
            const params = {
                owner: REPO_OWNER, repo: REPO_NAME, path: filename,
                message: "Update via Web App",
                content: utf8_to_b64(JSON.stringify(content, null, 2))
            };
            if (sha) params.sha = sha;

            try {
                const response = await octokit.request(`PUT /repos/${REPO_OWNER}/${REPO_NAME}/contents/${filename}`, params);
                hideSpinner();
                return response.data.content.sha;
            } catch (e) {
                hideSpinner();
                alert("Save Error: " + e.message);
                throw e;
            }
        }

        async function loadTeam() {
            const data = await getFile(TEAM_FILE);
            teamData = data.content || ["Carson", "Dave Miller"];
            teamSha = data.sha;
        }

        async function loadTypes() {
            const data = await getFile(TYPES_FILE);
            typeData = data.content || DEFAULT_TYPES;
            typeSha = data.sha;
        }

        async function loadSchedule() {
            const data = await getFile(SCHEDULE_FILE);
            scheduleData = data.content || [];
            scheduleSha = data.sha;
        }

        // --- CALENDAR LOGIC ---
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listMonth' },
                events: scheduleData,
                height: '80vh',
                themeSystem: 'bootstrap5',
                editable: true,
                droppable: true,
                eventResizableFromStart: true,
                
                eventClick: function(info) {
                    openEventModal(info.event);
                },

                eventDrop: async function(info) {
                    await handleDragResize(info.event);
                },

                eventResize: async function(info) {
                    await handleDragResize(info.event);
                },

                eventContent: function(arg) {
                    let members = [];
                    if (arg.event.extendedProps && arg.event.extendedProps.members) {
                        members = arg.event.extendedProps.members;
                    } else if (arg.event.resourceId) {
                        members = [arg.event.resourceId];
                    }
                    
                    let memberString = members.join(", ");
                    return {
                        html: `<div>
                                <span class="event-title">${arg.event.title}</span>
                                <span class="event-members">${memberString}</span>
                               </div>`
                    };
                }
            });
            calendar.render();
        }

        async function handleDragResize(event) {
            const index = scheduleData.findIndex(e => e.id === event.id);
            if (index > -1) {
                scheduleData[index].start = event.startStr;
                scheduleData[index].end = event.endStr;
                scheduleSha = await saveFile(SCHEDULE_FILE, scheduleData, scheduleSha);
            }
        }

        // --- MODAL LOGIC ---
        function openEventModal(event = null) {
            const list = document.getElementById('member-checkbox-list');
            list.innerHTML = "";
            teamData.forEach(member => {
                const li = document.createElement("li");
                li.innerHTML = `
                    <label class="dropdown-item-checkbox text-white">
                        <input type="checkbox" class="form-check-input me-2 member-check" value="${member}">
                        ${member}
                    </label>`;
                list.appendChild(li);
            });
            
            const typeSelect = document.getElementById('evt-type');
            typeSelect.innerHTML = "";
            typeData.forEach(type => {
                const opt = document.createElement("option");
                opt.value = type.color; 
                opt.innerText = type.name;
                opt.setAttribute('data-name', type.name);
                typeSelect.appendChild(opt);
            });

            if (event) {
                document.getElementById('eventModalTitle').innerText = "Edit Schedule Item";
                document.getElementById('evt-id').value = event.id;
                document.getElementById('evt-title').value = event.title;
                document.getElementById('btn-delete-event').style.display = "block";
                
                const typeName = event.extendedProps.type;
                const typeOpt = Array.from(typeSelect.options).find(opt => opt.getAttribute('data-name') === typeName);
                if (typeOpt) typeSelect.value = typeOpt.value;

                const members = event.extendedProps.members || [];
                document.querySelectorAll('.member-check').forEach(box => {
                    if (members.includes(box.value)) box.checked = true;
                });

                let displayEnd = new Date(event.end);
                displayEnd.setDate(displayEnd.getDate() - 1);
                fpInstance.setDate([event.start, displayEnd]);

            } else {
                document.getElementById('eventModalTitle').innerText = "New Schedule Item";
                document.getElementById('evt-id').value = "";
                document.getElementById('evt-title').value = "";
                document.getElementById('btn-delete-event').style.display = "none";
                fpInstance.clear();
            }
            
            document.querySelectorAll('.member-check').forEach(box => {
                box.addEventListener('change', updateSelectedCount);
            });
            updateSelectedCount();

            new bootstrap.Modal(document.getElementById('eventModal')).show();
        }

        function updateSelectedCount() {
            const checked = document.querySelectorAll('.member-check:checked');
            const btn = document.getElementById('multiSelectBtn');
            if (checked.length === 0) btn.innerText = "Select Members...";
            else if (checked.length === 1) btn.innerText = checked[0].value;
            else btn.innerText = `${checked.length} Members Selected`;
        }

        // --- NEW SAVE LOGIC WITH CONFLICT CHECK ---
        async function prepareSaveEvent() {
            const id = document.getElementById('evt-id').value;
            const title = document.getElementById('evt-title').value;
            const typeSelect = document.getElementById('evt-type');
            const color = typeSelect.value;
            const typeName = typeSelect.options[typeSelect.selectedIndex].getAttribute('data-name');
            
            const selectedDates = fpInstance.selectedDates;
            if (!selectedDates || selectedDates.length < 2) return alert("Select Start & End Dates.");
            
            const startStr = fpInstance.formatDate(selectedDates[0], "Y-m-d");
            let endDate = new Date(selectedDates[1]);
            endDate.setDate(endDate.getDate() + 1); 
            const endStr = endDate.toISOString().split('T')[0];

            const checkboxes = document.querySelectorAll('.member-check:checked');
            const selectedMembers = Array.from(checkboxes).map(cb => cb.value);

            if (!title || selectedMembers.length === 0) return alert("Title and Members required.");

            pendingSaveData = {
                id: id || crypto.randomUUID(),
                title: title, 
                start: startStr,
                end: endStr,
                backgroundColor: color,
                borderColor: color,
                extendedProps: { type: typeName, members: selectedMembers }
            };

            // CHECK CONFLICTS
            const newStart = new Date(startStr);
            const newEnd = new Date(endStr);
            let conflicts = [];

            for (let event of scheduleData) {
                if (id && event.id === id) continue; 
                if (!event.start || !event.end) continue;
                
                const evStart = new Date(event.start);
                const evEnd = new Date(event.end);
                
                if (newStart < evEnd && newEnd > evStart) {
                    const existingGroup = event.extendedProps.members || (event.resourceId ? [event.resourceId] : []);
                    const overlaps = selectedMembers.filter(m => existingGroup.includes(m));
                    
                    if (overlaps.length > 0) {
                        overlaps.forEach(person => {
                            // FORMAT DATES NICELY
                            const displayStart = formatDateForDisplay(event.start);
                            // Subtract 1 day from end date for Inclusive Display ("Feb 24" instead of "Feb 25")
                            let endObj = new Date(event.end);
                            endObj.setDate(endObj.getDate() - 1);
                            const displayEnd = endObj.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                            
                            conflicts.push(`<b>${person}</b> is busy with "<i>${event.title}</i>" (${displayStart} - ${displayEnd})`);
                        });
                    }
                }
            }

            if (conflicts.length > 0) {
                const conflictList = document.getElementById('conflict-list');
                conflictList.innerHTML = "";
                conflicts.forEach(c => {
                    const li = document.createElement("li");
                    li.className = "list-group-item bg-dark text-white border-secondary";
                    li.innerHTML = c;
                    conflictList.appendChild(li);
                });
                new bootstrap.Modal(document.getElementById('conflictModal')).show();
            } else {
                finalizeSave();
            }
        }

        function confirmForceSave() {
            bootstrap.Modal.getInstance(document.getElementById('conflictModal')).hide();
            finalizeSave();
        }

        async function finalizeSave() {
            if (!pendingSaveData) return;
            
            const eventObj = pendingSaveData;
            const index = scheduleData.findIndex(e => e.id === eventObj.id);
            if (index > -1) {
                scheduleData[index] = eventObj;
                const calEvent = calendar.getEventById(eventObj.id);
                if (calEvent) {
                    calEvent.setProp('title', eventObj.title);
                    calEvent.setProp('backgroundColor', eventObj.backgroundColor);
                    calEvent.setProp('borderColor', eventObj.borderColor);
                    calEvent.setDates(eventObj.start, eventObj.end);
                    calEvent.setExtendedProp('members', eventObj.extendedProps.members);
                    calEvent.setExtendedProp('type', eventObj.extendedProps.type);
                }
            } else {
                scheduleData.push(eventObj);
                calendar.addEvent(eventObj);
            }

            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
            scheduleSha = await saveFile(SCHEDULE_FILE, scheduleData, scheduleSha);
            pendingSaveData = null;
        }

        async function deleteEvent() {
            const id = document.getElementById('evt-id').value;
            if (!id || !confirm("Delete this item?")) return;

            const index = scheduleData.findIndex(e => e.id === id);
            if (index > -1) {
                scheduleData.splice(index, 1);
                const calEvent = calendar.getEventById(id);
                if (calEvent) calEvent.remove();
                
                bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                scheduleSha = await saveFile(SCHEDULE_FILE, scheduleData, scheduleSha);
            }
        }

        // --- TEAM MANAGER ---
        function openTeamManager() {
            cancelTeamEdit();
            renderTeamList();
            new bootstrap.Modal(document.getElementById('teamModal')).show();
        }

        function renderTeamList() {
            const list = document.getElementById('team-list');
            list.innerHTML = "";
            teamData.forEach((member, index) => {
                const li = document.createElement("li");
                li.className = "list-group-item bg-dark text-white d-flex justify-content-between align-items-center border-secondary";
                li.innerHTML = `
                    <span>üë§ ${member}</span> 
                    <div>
                        <button class="btn btn-sm btn-outline-warning btn-icon" onclick="startEditMember(${index})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-outline-danger btn-icon" onclick="removeMember(${index})">üóëÔ∏è</button>
                    </div>`;
                list.appendChild(li);
            });
        }

        function startEditMember(index) {
            editingTeamIndex = index;
            document.getElementById('new-member-name').value = teamData[index];
            document.getElementById('btn-team-submit').innerText = "Update";
            document.getElementById('btn-team-submit').className = "btn btn-warning";
            document.getElementById('btn-team-cancel').style.display = "inline-block";
        }

        function cancelTeamEdit() {
            editingTeamIndex = -1;
            document.getElementById('new-member-name').value = "";
            document.getElementById('btn-team-submit').innerText = "Add";
            document.getElementById('btn-team-submit').className = "btn btn-success";
            document.getElementById('btn-team-cancel').style.display = "none";
        }

        async function handleMemberSubmit() {
            const name = document.getElementById('new-member-name').value.trim();
            if (!name) return;

            if (editingTeamIndex > -1) {
                const oldName = teamData[editingTeamIndex];
                teamData[editingTeamIndex] = name;
                teamData.sort();
                
                let scheduleChanged = false;
                scheduleData.forEach(ev => {
                    let mems = (ev.extendedProps && ev.extendedProps.members) ? ev.extendedProps.members : [];
                    if (mems.includes(oldName)) {
                        ev.extendedProps.members = mems.map(m => m === oldName ? name : m);
                        scheduleChanged = true;
                    }
                });

                renderTeamList();
                cancelTeamEdit();
                
                teamSha = await saveFile(TEAM_FILE, teamData, teamSha);
                if (scheduleChanged) {
                    scheduleSha = await saveFile(SCHEDULE_FILE, scheduleData, scheduleSha);
                    initCalendar();
                }
            } else {
                if (!teamData.includes(name)) {
                    teamData.push(name);
                    teamData.sort();
                    renderTeamList();
                    document.getElementById('new-member-name').value = "";
                    teamSha = await saveFile(TEAM_FILE, teamData, teamSha);
                }
            }
        }

        async function removeMember(index) {
            if(confirm(`Remove ${teamData[index]}?`)) {
                teamData.splice(index, 1);
                renderTeamList();
                teamSha = await saveFile(TEAM_FILE, teamData, teamSha);
            }
        }

        // --- TYPE MANAGER ---
        function openTypeManager() {
            cancelTypeEdit();
            renderTypeList();
            new bootstrap.Modal(document.getElementById('typeModal')).show();
        }

        function renderTypeList() {
            const list = document.getElementById('type-list');
            list.innerHTML = "";
            typeData.forEach((type, index) => {
                const li = document.createElement("li");
                li.className = "list-group-item bg-dark text-white d-flex justify-content-between align-items-center border-secondary";
                li.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="color-swatch" style="background-color:${type.color};"></span>
                        <span>${type.name}</span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-warning btn-icon" onclick="startEditType(${index})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-outline-danger btn-icon" onclick="removeType(${index})">üóëÔ∏è</button>
                    </div>`;
                list.appendChild(li);
            });
        }

        function startEditType(index) {
            editingTypeIndex = index;
            const type = typeData[index];
            document.getElementById('new-type-name').value = type.name;
            document.getElementById('new-type-color').value = type.color;
            document.getElementById('btn-type-submit').innerText = "Update";
            document.getElementById('btn-type-submit').className = "btn btn-warning";
            document.getElementById('btn-type-cancel').style.display = "inline-block";
        }

        function cancelTypeEdit() {
            editingTypeIndex = -1;
            document.getElementById('new-type-name').value = "";
            document.getElementById('new-type-color').value = "#0d6efd";
            document.getElementById('btn-type-submit').innerText = "Add";
            document.getElementById('btn-type-submit').className = "btn btn-success";
            document.getElementById('btn-type-cancel').style.display = "none";
        }

        async function handleTypeSubmit() {
            const name = document.getElementById('new-type-name').value.trim();
            const color = document.getElementById('new-type-color').value;
            if (!name) return;

            if (editingTypeIndex > -1) {
                const oldType = typeData[editingTypeIndex];
                const oldName = oldType.name;
                typeData[editingTypeIndex] = { name: name, color: color };
                
                let scheduleChanged = false;
                scheduleData.forEach(ev => {
                    if (ev.extendedProps && ev.extendedProps.type === oldName) {
                        ev.extendedProps.type = name;
                        ev.backgroundColor = color;
                        ev.borderColor = color;
                        scheduleChanged = true;
                    }
                });

                renderTypeList();
                cancelTypeEdit();
                typeSha = await saveFile(TYPES_FILE, typeData, typeSha);
                if (scheduleChanged) {
                    scheduleSha = await saveFile(SCHEDULE_FILE, scheduleData, scheduleSha);
                    initCalendar();
                }
            } else {
                if (!typeData.some(t => t.name === name)) {
                    typeData.push({ name: name, color: color });
                    renderTypeList();
                    document.getElementById('new-type-name').value = "";
                    typeSha = await saveFile(TYPES_FILE, typeData, typeSha);
                }
            }
        }

        async function removeType(index) {
            if(confirm(`Delete activity type "${typeData[index].name}"?`)) {
                typeData.splice(index, 1);
                renderTypeList();
                typeSha = await saveFile(TYPES_FILE, typeData, typeSha);
            }
        }
    </script>
</body>
</html>
